<html>
<head>

<style>
body {
  padding: 20px;
}

#banner-message {
  background: #fff;
  border-radius: 4px;
  padding: 20px;
  font-size: 25px;
  text-align: center;
  transition: all 0.2s;
  margin: 0 auto;
  width: 300px;
}



button {
  background: #2084FF; // #2084FF;
  border: none;
  border-radius: 3px;
  padding: 4px 8px;
  font-size: 15px;
  color: #fff;
}

#banner-message.alt {
  background: #0084FF;
  color: #fff;
  margin-top: 40px;
  width: 200px;
}

#banner-message.alt button {
  background: #fff;
  color: #000;
}

#container {
  border-left: 1px solid #999;
  border-top: 1px solid #999;
}

.row {
  height: 15px;
  clear: both;
}

.node {
  float: left;
  border-right: 1px solid #999;
  border-bottom: 1px solid #999;
  height: 100%;
}

#controls {
  position: absolute;
  right: 0.2em;
  top: 0.2em;
  background-color: #FF8400;
  border-radius: 0.5em;
  padding: 1em;
  opacity: 0.8;
}

#controls:hover {
  opacity: 1;
}
</style>

</head>
<body>


<script>

COLOR_THEMES = [
	 ["#333333","#FFFFCC","#33BB33","#33BBBB","#BB3333","#BB33BB","#BBBB33","#BBBBBB","#BADDFF","#E2F2FF"]
	,["#20F9FF","#2084FF","#007AFF","#0084FF","#008EFF","#0098FF","#00A2FF","#00ACFF","#00B6FF","#00C0FF"]
	,["#0076FF","#007DFF","#0084FF","#008BFF","#0092FF","#0099FF","#00A0FF","#00A7FF","#00AEFF","#00B5FF"]
	,["#0084FF","#008EFF","#0098FF","#00A2FF","#00ACFF","#00B6FF","#00C0FF","#00CAFF","#00D4FF","#00DEFF"]
	,["#2084FF","#2091FF","#209EFF","#20ABFF","#20B8FF","#20C5FF","#20D2FF","#20DFFF","#20ECFF","#20F9FF"]
	,["#20F9FF","#20ECFF","#20DFFF","#20D2FF","#20C5FF","#20B8FF","#20ABFF","#209EFF","#2091FF","#2084FF"]
];


var game = {
  currentColorTheme: 1,
  interval: 10,
  gridSize: 50,
  cellSize: 10,
  generationCycle:2,
  toroidal: false,
  started: false,
  grid: []
  // для игры Жизнь
  ,population: 0
  ,generation: 0
  ,maxState: 1
  ,born: [3]
  ,survive: [2,3]
  // для диффузии используем смещение клеток внутри области Марголиса с вероятностью pTurn
  ,pTurn: 0.5 // вероятность поворота области
};

/////////////////////////////////////////////////////////////////////////////////////////////////

function initialize() {
  document.getElementById("container").style.width = game.gridSize * game.cellSize + game.gridSize + "px";
  for (var i = 1; i <= game.gridSize; i++) {
    game.grid[i] = [];
    var row = document.createElement("div");
    row.className = "row";
    row.id = "row" + i;
    row.style.height = game.cellSize + "px";
    document.getElementById("container").appendChild(row);
    for (var j = 1; j <= game.gridSize; j++) {
      game.grid[i][j] = 0;
      var node = document.createElement("div");
      node.className = "node";
      node.id = "node" + i + "-" + j;
      node.style.width = game.cellSize + "px";
      node.onclick = function() {
        click(this);
        if (!game.started){drawGrid()};
      }
      document.getElementById("row" + i).appendChild(node);
    }
  }
  initGame();
}

/////////////////////////////////////////////////////////////////////////////////////////////////

function drawGrid() {
  var k = 0, e = 0

  for (var i = 1; i <= game.gridSize; i++) {
    for (var j = 1; j <= game.gridSize; j++) {
      e=game.grid[i][j];
      k+=e;
      document.getElementById("node" + i + "-" + j).style.backgroundColor =
        (e<1)?COLOR_THEMES[game.currentColorTheme][0]:
        (e<2)?COLOR_THEMES[game.currentColorTheme][1]:
        (e<3)?COLOR_THEMES[game.currentColorTheme][2]:
        (e<4)?COLOR_THEMES[game.currentColorTheme][3]:
        (e<5)?COLOR_THEMES[game.currentColorTheme][4]:
        (e<6)?COLOR_THEMES[game.currentColorTheme][5]:
        (e<7)?COLOR_THEMES[game.currentColorTheme][6]:
        (e<8)?COLOR_THEMES[game.currentColorTheme][7]:
        (e<9)?COLOR_THEMES[game.currentColorTheme][8]:
        (e>=9)?COLOR_THEMES[game.currentColorTheme][9]:
	"#000000";}}

  document.getElementById("counters").innerHTML=
    "<div>Generation: "+game.generation+"</div>"
    +"<div>Population: "+game.population+"</div>"
    ;
} // drawGrid()


function click(node) {
  var nodeID = node.id.slice(4); // node3-16
  var separator = nodeID.indexOf("-");
  var nodeX = +nodeID.slice(0, separator);
  var nodeY = +nodeID.slice(separator + 1);

  game.grid[nodeX][nodeY]++;
  if (game.grid[nodeX][nodeY]>game.maxState)
  {
    game.grid[nodeX][nodeY]=0;
    game.population--;
  }
  else
    game.population++;
} // click(node)


/////////////////////////////////////////////////////////////////////////////////////////////////

function newGeneration(){
  var c = 0
  var s = []

  var newGrid = [] // новое состояние поля
  for (var x = 1; x <= game.gridSize; x++) {
    newGrid[x] = [];
    for (var y = 1; y <= game.gridSize; y++) {
      newGrid[x][y] = game.grid[x][y];
  }}

  // первый проход - по нечетным полям
  for (var x = 1; x < game.gridSize; x=x+2) {
    for (var y = 1; y < game.gridSize; y=y+2) {

      s[1]=newGrid[ x ][ y ];s[2]=newGrid[ x ][y+1];
      s[4]=newGrid[x+1][ y ];s[3]=newGrid[x+1][y+1];

      if(Math.random()>game.pTurn){
        if(Math.random()<0.5)
          {
            s[5]=s[1];s[1]=s[2];s[2]=s[3];s[3]=s[4];s[4]=s[5];
          }
          else
          {
            s[5]=s[1];s[1]=s[4];s[4]=s[3];s[3]=s[2];s[2]=s[5];
          }

          newGrid[ x ][ y ]=s[1];newGrid[ x ][y+1]=s[2];
          newGrid[x+1][ y ]=s[4];newGrid[x+1][y+1]=s[3];
      };
  }};

  // второй проход - по четным полям
  for (var x = 2; x < game.gridSize; x=x+2) {
    for (var y = 2; y < game.gridSize; y=y+2) {

      s[1]=newGrid[ x ][ y ];s[2]=newGrid[ x ][y+1];
      s[4]=newGrid[x+1][ y ];s[3]=newGrid[x+1][y+1];

      if(Math.random()>game.pTurn){
        if(Math.random()<0.5)
          {
            s[5]=s[1];s[1]=s[2];s[2]=s[3];s[3]=s[4];s[4]=s[5];
          }
          else
          {
            s[5]=s[1];s[1]=s[4];s[4]=s[3];s[3]=s[2];s[2]=s[5];
          }

          newGrid[ x ][ y ]=s[1];newGrid[ x ][y+1]=s[2];
          newGrid[x+1][ y ]=s[4];newGrid[x+1][y+1]=s[3];
      };
  }};

  for (var x = 1; x <= game.gridSize; x++) {
    for (var y = 1; y <= game.gridSize; y++) {
      game.grid[x][y]=newGrid[x][y]
  }};

  game.generation++;
}

var curGenerationCycle = 0;

function flow() {
  // generation
  if (curGenerationCycle%game.generationCycle==0){
    generationCycle = 0;
    newGeneration();
  }
  curGenerationCycle++;
}; // flow


/////////////////////////////////////////////////////////////////////////////////////////////////

function initGame(startShapeType){
  game.started = false;
  game.generation = 0;
  game.population = 0;
  for (var i = 1; i <= game.gridSize; i++) {
    for (var j = 1; j <= game.gridSize; j++) {

      if(
        ((startShapeType==1)&(i>=game.gridSize*0/3)&(i<=game.gridSize*1/3)&(j>=game.gridSize*0/3)&(j<=game.gridSize*1/3))||
        ((startShapeType==2)&(i>=game.gridSize*1/3)&(i<=game.gridSize*2/3)&(j>=game.gridSize*1/3)&(j<=game.gridSize*2/3))||
        ((startShapeType==3)&(i>=game.gridSize*0/3)&(i<=game.gridSize*1/3)&(j>=game.gridSize*0/3)&(j<=game.gridSize*1/3))||
        ((startShapeType==3)&(i>=game.gridSize*2/3)&(i<=game.gridSize*3/3)&(j>=game.gridSize*2/3)&(j<=game.gridSize*3/3))
      )
        {game.grid[i][j]=1}
        else
        {game.grid[i][j]=0}
      if (game.grid[i][j]>0){
        game.population++;
      }
    }
  }
  drawGrid();
}

function saveGame(){
  localStorage.setItem("game", JSON.stringify(game));
}


function loadGame(){
  game = JSON.parse(localStorage.getItem("game"));
  drawGrid();
}


function stopGame(){
  if (game.started){
    clearInterval(timerId);
    game.started = false;
  }
};


function startGame(){
  game.started = true;
  setTimeout(function run() {
    flow();
	  drawGrid();
    if (game.started){
	    timerId = setTimeout(run, game.interval)
    }
  }, game.interval);
};

document.addEventListener("DOMContentLoaded", initialize);

/////////////////////////////////////////////////////////////////////////////////////////////////

</script>

<h1 id="h1">Grid/Diffusion project</h1>
<p></p>
<div style="#controls">
  <button id="init" onclick="initGame(1)">Init One Corner</button>
  <button id="init" onclick="initGame(2)">Init Center</button>
  <button id="init" onclick="initGame(3)">Init Two Corners</button>
  <button id="start" onclick="startGame()">Start</button>
  <button id="stop" onclick="stopGame()">Stop</button>
  <button id="save" onclick="saveGame()">Save</button>
  <button id="load" onclick="loadGame()">Load</button>
</div>
<p></p>
<div id="container" style="width:0px;"></div>
<p></p>
<div id="counters" style="#banner-message"></div>
<p></p>
<div><a href="https://github.com/LuckyCat14/Grid">https://github.com/LuckyCat14/Grid</a></div>
</body>
</html>
